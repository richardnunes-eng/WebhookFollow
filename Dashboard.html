<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöö Dashboard de Rotas | ClickUp + GreenMile</title>
    <base target="_top">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <style>
        /* ===== CSS Variables ===== */
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --bg-card: rgba(26, 26, 37, 0.8);
            --bg-glass: rgba(255, 255, 255, 0.03);
            --text-primary: #f0f0f5;
            --text-secondary: #8b8b99;
            --text-muted: #5a5a6a;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            --status-success: #22c55e;
            --status-success-bg: rgba(34, 197, 94, 0.15);
            --status-warning: #f59e0b;
            --status-warning-bg: rgba(245, 158, 11, 0.15);
            --status-danger: #ef4444;
            --status-danger-bg: rgba(239, 68, 68, 0.15);
            --status-info: #3b82f6;
            --status-info-bg: rgba(59, 130, 246, 0.15);
            --status-neutral: #64748b;
            --status-neutral-bg: rgba(100, 116, 139, 0.15);
            --border-color: rgba(255, 255, 255, 0.08);
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            --shadow-glow: 0 0 40px rgba(99, 102, 241, 0.15);
            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-display: 'Outfit', 'Inter', sans-serif;
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-primary);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            background-image:
                radial-gradient(ellipse at 20% 0%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(139, 92, 246, 0.06) 0%, transparent 50%);
        }

        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            min-height: 100vh;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: var(--bg-glass);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo-icon {
            font-size: 2rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        .logo h1 {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .badge {
            padding: 4px 16px;
            background: var(--accent-gradient);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .last-update {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            background: var(--status-success);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .btn-refresh {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .btn-refresh:hover {
            background: var(--accent-primary);
            transform: rotate(180deg);
        }

        .btn-refresh.loading svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        /* KPIs */
        .kpis-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
        }

        .kpi-card {
            position: relative;
            padding: 20px;
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            display: flex;
            flex-direction: column;
            gap: 8px;
            cursor: pointer;
            transition: all var(--transition-normal);
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-gradient);
            opacity: 0;
            transition: opacity var(--transition-fast);
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            border-color: rgba(99, 102, 241, 0.3);
            box-shadow: var(--shadow-glow);
        }

        .kpi-card:hover::before {
            opacity: 1;
        }

        .kpi-card[data-status="total"]::before {
            background: var(--accent-primary);
        }

        .kpi-card[data-status="finalizado"]::before {
            background: var(--status-success);
        }

        .kpi-card[data-status="emrota"]::before {
            background: var(--status-info);
        }

        .kpi-card[data-status="nocliente"]::before {
            background: var(--status-warning);
        }

        .kpi-card[data-status="critico"]::before {
            background: var(--status-danger);
        }

        .kpi-card[data-status="retorno"]::before {
            background: #f97316;
        }

        .kpi-card[data-status="reentrega"]::before {
            background: var(--status-neutral);
        }

        .kpi-icon {
            font-size: 1.5rem;
        }

        .kpi-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .kpi-value {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
        }

        .kpi-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .kpi-progress {
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-bar {
            height: 100%;
            background: var(--status-success);
            border-radius: 2px;
            transition: width 0.4s;
        }

        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 24px;
        }

        .chart-card {
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: 24px;
        }

        .chart-title {
            font-family: var(--font-display);
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-secondary);
        }

        .donut-chart {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }

        .donut-chart svg {
            transform: rotate(-90deg);
        }

        .donut-chart-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .donut-chart-value {
            font-family: var(--font-display);
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .donut-chart-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 20px;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* Bar Chart */
        .bar-chart {
            display: flex;
            align-items: flex-end;
            gap: 16px;
            height: 180px;
            padding: 20px 0;
        }

        .bar-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .bar {
            width: 100%;
            max-width: 60px;
            border-radius: 8px 8px 0 0;
            transition: height 0.5s ease;
            position: relative;
        }

        .bar::after {
            content: attr(data-value);
            position: absolute;
            top: -24px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .bar-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-align: center;
            max-width: 70px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Filters */
        .filters-section {
            display: flex;
            align-items: center;
            gap: 24px;
            flex-wrap: wrap;
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            flex: 1;
            max-width: 400px;
            transition: all var(--transition-fast);
        }

        .search-box:focus-within {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        .search-box svg {
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .search-box input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 0.9375rem;
            outline: none;
        }

        .search-box input::placeholder {
            color: var(--text-muted);
        }

        .filter-chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .chip {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .chip:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .chip.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        /* Table */
        .table-section {
            flex: 1;
        }

        .glass-card {
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
        }

        .table-container {
            overflow-x: auto;
        }

        .routes-table {
            width: 100%;
            border-collapse: collapse;
        }

        .routes-table th,
        .routes-table td {
            padding: 14px 20px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .routes-table th {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .routes-table tbody tr {
            transition: background var(--transition-fast);
        }

        .routes-table tbody tr:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .routes-table tbody tr:last-child td {
            border-bottom: none;
        }

        .route-name {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .route-key {
            font-weight: 600;
            color: var(--text-primary);
        }

        .route-id {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.finalizado {
            background: var(--status-success-bg);
            color: var(--status-success);
        }

        .status-badge.emrota {
            background: var(--status-info-bg);
            color: var(--status-info);
        }

        .status-badge.nocliente {
            background: var(--status-warning-bg);
            color: var(--status-warning);
        }

        .status-badge.critico {
            background: var(--status-danger-bg);
            color: var(--status-danger);
            animation: blink 1.5s ease-in-out infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        .status-badge.retorno {
            background: rgba(249, 115, 22, 0.15);
            color: #f97316;
        }

        .status-badge.reentrega {
            background: var(--status-neutral-bg);
            color: var(--status-neutral);
        }

        .cell-progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-ring {
            width: 36px;
            height: 36px;
        }

        .progress-ring-bg {
            stroke: var(--bg-tertiary);
        }

        .progress-ring-fill {
            stroke: var(--status-success);
            transition: stroke-dashoffset 0.5s ease;
        }

        .progress-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .client-info {
            display: flex;
            flex-direction: column;
        }

        .client-name {
            font-weight: 500;
        }

        .client-address {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .time-ago {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            text-decoration: none;
            transition: all var(--transition-fast);
        }

        .action-btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .table-empty {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px;
            text-align: center;
        }

        .table-empty.visible {
            display: flex;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .table-empty p {
            font-size: 1.125rem;
            font-weight: 500;
        }

        .table-empty span {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* Footer */
        .footer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 16px;
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.online {
            background: var(--status-success);
            box-shadow: 0 0 8px var(--status-success);
        }

        .status-dot.offline {
            background: var(--status-danger);
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 10, 15, 0.9);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.25s;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
        }

        .loader-truck {
            font-size: 4rem;
            animation: drive 1.5s ease-in-out infinite;
        }

        @keyframes drive {

            0%,
            100% {
                transform: translateX(-10px);
            }

            50% {
                transform: translateX(10px);
            }
        }

        .loader-text {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1001;
        }

        .toast {
            padding: 16px 24px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            color: var(--text-primary);
            font-size: 0.875rem;
            animation: slideIn 0.3s ease-out;
        }

        .toast.success {
            border-left: 3px solid var(--status-success);
        }

        .toast.error {
            border-left: 3px solid var(--status-danger);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                padding: 16px;
                gap: 16px;
            }

            .header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .header-left {
                flex-direction: column;
            }

            .filters-section {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                max-width: none;
            }

            .kpis-section {
                grid-template-columns: repeat(2, 1fr);
            }

            .kpi-value {
                font-size: 1.5rem;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="logo">
                    <span class="logo-icon">üöö</span>
                    <h1>Dashboard de Rotas</h1>
                </div>
                <span class="badge">ClickUp + GreenMile</span>
            </div>
            <div class="header-right">
                <div class="last-update" id="lastUpdate">
                    <span class="pulse-dot"></span>
                    <span>Carregando...</span>
                </div>
                <button class="btn-refresh" id="btnRefresh" title="Atualizar">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12a9 9 0 11-2.52-6.25" />
                        <path d="M21 3v6h-6" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- KPIs -->
        <section class="kpis-section">
            <div class="kpi-card" data-status="total">
                <div class="kpi-icon">üöö</div>
                <div class="kpi-content">
                    <span class="kpi-value" id="kpiRotasAtivas">0</span>
                    <span class="kpi-label">Rotas Ativas</span>
                </div>
            </div>
            <div class="kpi-card" data-status="finalizado">
                <div class="kpi-icon">‚úÖ</div>
                <div class="kpi-content">
                    <span class="kpi-value" id="kpiFinalizadas">0</span>
                    <span class="kpi-label">Finalizadas</span>
                </div>
                <div class="kpi-progress">
                    <div class="progress-bar" id="progressFinalizadas" style="width: 0%"></div>
                </div>
            </div>
            <div class="kpi-card" data-status="emrota">
                <div class="kpi-icon">üîÑ</div>
                <div class="kpi-content">
                    <span class="kpi-value" id="kpiEmRota">0</span>
                    <span class="kpi-label">Em Rota</span>
                </div>
            </div>
            <div class="kpi-card" data-status="nocliente">
                <div class="kpi-icon">‚è∞</div>
                <div class="kpi-content">
                    <span class="kpi-value" id="kpiNoCliente">0</span>
                    <span class="kpi-label">No Cliente</span>
                </div>
            </div>
            <div class="kpi-card" data-status="critico">
                <div class="kpi-icon">üî¥</div>
                <div class="kpi-content">
                    <span class="kpi-value" id="kpiCritico">0</span>
                    <span class="kpi-label">Cr√≠tico</span>
                </div>
            </div>
            <div class="kpi-card" data-status="retorno">
                <div class="kpi-icon">‚Ü©Ô∏è</div>
                <div class="kpi-content">
                    <span class="kpi-value" id="kpiRetorno">0</span>
                    <span class="kpi-label">Retornos</span>
                </div>
            </div>
            <div class="kpi-card" data-status="reentrega">
                <div class="kpi-icon">‚ôªÔ∏è</div>
                <div class="kpi-content">
                    <span class="kpi-value" id="kpiReentrega">0</span>
                    <span class="kpi-label">Reentregas</span>
                </div>
            </div>
        </section>

        <!-- Charts -->
        <section class="charts-section">
            <div class="chart-card">
                <div class="chart-title">üìä Distribui√ß√£o de Status</div>
                <div class="donut-chart" id="donutChart">
                    <svg width="200" height="200" viewBox="0 0 200 200">
                        <circle class="donut-chart-bg" cx="100" cy="100" r="80" fill="none" stroke="#1a1a25"
                            stroke-width="20" />
                        <circle id="donutFinalizadas" cx="100" cy="100" r="80" fill="none" stroke="#22c55e"
                            stroke-width="20" stroke-dasharray="0 502" stroke-linecap="round" />
                        <circle id="donutEmRota" cx="100" cy="100" r="80" fill="none" stroke="#3b82f6" stroke-width="20"
                            stroke-dasharray="0 502" stroke-linecap="round" />
                        <circle id="donutNoCliente" cx="100" cy="100" r="80" fill="none" stroke="#f59e0b"
                            stroke-width="20" stroke-dasharray="0 502" stroke-linecap="round" />
                        <circle id="donutCritico" cx="100" cy="100" r="80" fill="none" stroke="#ef4444"
                            stroke-width="20" stroke-dasharray="0 502" stroke-linecap="round" />
                        <circle id="donutRetorno" cx="100" cy="100" r="80" fill="none" stroke="#f97316"
                            stroke-width="20" stroke-dasharray="0 502" stroke-linecap="round" />
                    </svg>
                    <div class="donut-chart-center">
                        <div class="donut-chart-value" id="donutTotal">0</div>
                        <div class="donut-chart-label">entregas</div>
                    </div>
                </div>
                <div class="chart-legend">
                    <div class="legend-item"><span class="legend-dot" style="background:#22c55e"></span>Finalizadas
                    </div>
                    <div class="legend-item"><span class="legend-dot" style="background:#3b82f6"></span>Em Rota</div>
                    <div class="legend-item"><span class="legend-dot" style="background:#f59e0b"></span>No Cliente</div>
                    <div class="legend-item"><span class="legend-dot" style="background:#ef4444"></span>Cr√≠tico</div>
                    <div class="legend-item"><span class="legend-dot" style="background:#f97316"></span>Retorno</div>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title">üìà Progresso por Rota</div>
                <div class="bar-chart" id="barChart">
                    <!-- Populated by JS -->
                </div>
            </div>
        </section>

        <!-- Filters -->
        <section class="filters-section">
            <div class="search-box">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8" />
                    <path d="m21 21-4.35-4.35" />
                </svg>
                <input type="text" id="searchInput" placeholder="Buscar rota, cliente...">
            </div>
            <div class="filter-chips" id="filterChips">
                <button class="chip active" data-filter="all">Todas</button>
                <button class="chip" data-filter="emrota">Em Rota</button>
                <button class="chip" data-filter="nocliente">No Cliente</button>
                <button class="chip" data-filter="critico">Cr√≠tico</button>
                <button class="chip" data-filter="finalizado">Finalizadas</button>
                <button class="chip" data-filter="retorno">Retornos</button>
            </div>
        </section>

        <!-- Table -->
        <section class="table-section">
            <div class="table-container glass-card">
                <table class="routes-table" id="routesTable">
                    <thead>
                        <tr>
                            <th>Rota</th>
                            <th>Status</th>
                            <th>Progresso</th>
                            <th>Cliente Atual</th>
                            <th>√öltima Atualiza√ß√£o</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="routesTableBody"></tbody>
                </table>
                <div class="table-empty" id="tableEmpty">
                    <div class="empty-icon">üì≠</div>
                    <p>Nenhuma rota encontrada</p>
                    <span>Aguardando dados...</span>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <span>WebhookFollow Dashboard v2.0</span>
            <span>‚Ä¢</span>
            <span id="connectionStatus" class="status-indicator">
                <span class="status-dot online"></span> Conectado
            </span>
        </footer>
    </div>

    <!-- Loading -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader">
            <div class="loader-truck">üöö</div>
            <div class="loader-text">Carregando rotas...</div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ===== State =====
        var state = { routes: [], filteredRoutes: [], currentFilter: 'all', searchQuery: '', rawData: null };

        // ===== DOM Elements =====
        var DOM = {
            kpiRotasAtivas: document.getElementById('kpiRotasAtivas'),
            kpiFinalizadas: document.getElementById('kpiFinalizadas'),
            kpiEmRota: document.getElementById('kpiEmRota'),
            kpiNoCliente: document.getElementById('kpiNoCliente'),
            kpiCritico: document.getElementById('kpiCritico'),
            kpiRetorno: document.getElementById('kpiRetorno'),
            kpiReentrega: document.getElementById('kpiReentrega'),
            progressFinalizadas: document.getElementById('progressFinalizadas'),
            routesTableBody: document.getElementById('routesTableBody'),
            tableEmpty: document.getElementById('tableEmpty'),
            searchInput: document.getElementById('searchInput'),
            filterChips: document.getElementById('filterChips'),
            btnRefresh: document.getElementById('btnRefresh'),
            lastUpdate: document.getElementById('lastUpdate'),
            connectionStatus: document.getElementById('connectionStatus'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            toastContainer: document.getElementById('toastContainer'),
            barChart: document.getElementById('barChart'),
            donutTotal: document.getElementById('donutTotal')
        };

        // ===== Status Map =====
        var STATUS_MAP = {
            'finalizada': 'finalizado', 'finalizado': 'finalizado', 'done': 'finalizado', 'complete': 'finalizado', 'entregue': 'finalizado',
            'em rota': 'emrota', 'em andamento': 'emrota',
            'no cliente': 'nocliente',
            'cr√≠tico': 'critico', 'critico': 'critico',
            'retorno': 'retorno', 'returned': 'retorno',
            'reentrega': 'reentrega'
        };

        function normalizeStatus(status) {
            if (!status) return 'emrota';
            return STATUS_MAP[status.toLowerCase().trim()] || 'emrota';
        }

        function formatTime(date) {
            if (!date) return '--:--';
            var d = new Date(date);
            return d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        function formatTimeAgo(date) {
            if (!date) return '-';
            var now = new Date();
            var d = new Date(date);
            var diff = Math.floor((now - d) / 1000);
            if (diff < 60) return 'Agora';
            if (diff < 3600) return Math.floor(diff / 60) + 'min';
            if (diff < 86400) return Math.floor(diff / 3600) + 'h';
            return d.toLocaleDateString('pt-BR');
        }

        // ===== Data Processing =====
        function processRoutes(data) {
            if (!data || !data.items) return [];
            return data.items.map(function (route) {
                var stops = route.items || [];
                var total = stops.length;
                var finalizadas = 0, retornos = 0, noCliente = 0, critico = 0, reentrega = 0, pendentes = 0;
                var currentClient = null, lastUpdate = null;

                // Usa taskUrl da rota se dispon√≠vel
                var taskUrl = route.taskUrl || null;

                stops.forEach(function (stop) {
                    // Primeiro tenta usar status do ClickUp, se n√£o tiver usa deliveryStatus do GreenMile
                    var clickupStatus = stop['clickup.subtaskStatus'];
                    var gmDeliveryStatus = stop['stop.deliveryStatus'];
                    var arrival = stop['stop.actualArrival'];
                    var departure = stop['stop.actualDeparture'];

                    // Captura URL da task do item se rota n√£o tiver
                    if (!taskUrl && stop['clickup.taskUrl']) {
                        taskUrl = stop['clickup.taskUrl'];
                    }

                    // Determina status baseado nos dados dispon√≠veis
                    var status = 'emrota'; // default

                    if (clickupStatus) {
                        // Usa status do ClickUp
                        status = normalizeStatus(clickupStatus);
                    } else if (gmDeliveryStatus) {
                        // Usa deliveryStatus do GreenMile
                        var gmLower = gmDeliveryStatus.toLowerCase();
                        if (gmLower === 'delivered' || gmLower === 'complete') {
                            status = 'finalizado';
                        } else if (gmLower === 'undelivered' || gmLower === 'failed') {
                            status = 'retorno';
                        } else if (arrival && !departure) {
                            status = 'nocliente';
                        } else if (gmLower === 'in_progress' || gmLower === 'inprogress') {
                            status = 'emrota';
                        }
                    } else if (arrival && !departure) {
                        status = 'nocliente';
                    }

                    // Contagem por status
                    if (status === 'finalizado') finalizadas++;
                    else if (status === 'retorno') retornos++;
                    else if (status === 'nocliente') noCliente++;
                    else if (status === 'critico') critico++;
                    else if (status === 'reentrega') reentrega++;
                    else pendentes++;

                    // Cliente atual (chegou mas n√£o saiu)
                    if (arrival && !departure) {
                        currentClient = {
                            name: stop['stop.location.description'] || 'Cliente',
                            address: stop['stop.location.addressLine1'] || ''
                        };
                    }

                    var times = [arrival, departure].filter(Boolean).map(function (t) { return new Date(t).getTime(); });
                    var maxTime = Math.max.apply(null, times.concat([0]));
                    if (maxTime > (lastUpdate || 0)) lastUpdate = maxTime;
                });

                // Status da rota baseado nas subtasks
                var routeStatus = 'emrota';
                if (critico > 0) routeStatus = 'critico';
                else if (noCliente > 0) routeStatus = 'nocliente';
                else if (reentrega > 0 && finalizadas === 0) routeStatus = 'reentrega';
                else if (finalizadas === total && total > 0) routeStatus = 'finalizado';
                else if (retornos > 0 && finalizadas + retornos === total) routeStatus = 'retorno';

                // Progresso = finalizadas + retornos (processados) / total
                var processados = finalizadas + retornos;
                var progress = total > 0 ? Math.round((processados / total) * 100) : 0;

                return {
                    key: route.routeKey,
                    status: routeStatus,
                    total: total,
                    finalizadas: finalizadas,
                    retornos: retornos,
                    noCliente: noCliente,
                    critico: critico,
                    reentrega: reentrega,
                    pendentes: pendentes,
                    progress: progress,
                    currentClient: currentClient,
                    lastUpdate: lastUpdate ? new Date(lastUpdate) : null,
                    taskUrl: taskUrl
                };
            });
        }


        function calculateKPIs(routes) {
            var totalStops = routes.reduce(function (sum, r) { return sum + r.total; }, 0);
            var finalizadas = routes.reduce(function (sum, r) { return sum + r.finalizadas; }, 0);
            var retornos = routes.reduce(function (sum, r) { return sum + r.retornos; }, 0);
            var noCliente = routes.reduce(function (sum, r) { return sum + r.noCliente; }, 0);
            var critico = routes.reduce(function (sum, r) { return sum + r.critico; }, 0);
            var pendentes = routes.reduce(function (sum, r) { return sum + r.pendentes; }, 0);

            return {
                total: routes.length,
                finalizadas: finalizadas,
                emRota: pendentes,
                noCliente: noCliente,
                critico: critico,
                retorno: retornos,
                reentrega: routes.filter(function (r) { return r.status === 'reentrega'; }).length,
                totalStops: totalStops
            };
        }

        // ===== Rendering =====
        function renderKPIs(kpis) {
            DOM.kpiRotasAtivas.textContent = kpis.total;
            DOM.kpiFinalizadas.textContent = kpis.finalizadas;
            DOM.kpiEmRota.textContent = kpis.emRota;
            DOM.kpiNoCliente.textContent = kpis.noCliente;
            DOM.kpiCritico.textContent = kpis.critico;
            DOM.kpiRetorno.textContent = kpis.retorno;
            DOM.kpiReentrega.textContent = kpis.reentrega;
            var pct = kpis.totalStops > 0 ? Math.round((kpis.finalizadas / kpis.totalStops) * 100) : 0;
            DOM.progressFinalizadas.style.width = pct + '%';
        }

        function renderDonutChart(kpis) {
            var total = kpis.finalizadas + kpis.emRota + kpis.noCliente + kpis.critico + kpis.retorno;
            if (total === 0) total = 1;

            var circumference = 2 * Math.PI * 80; // 502
            var offset = 0;

            var segments = [
                { id: 'donutFinalizadas', value: kpis.finalizadas },
                { id: 'donutEmRota', value: kpis.emRota },
                { id: 'donutNoCliente', value: kpis.noCliente },
                { id: 'donutCritico', value: kpis.critico },
                { id: 'donutRetorno', value: kpis.retorno }
            ];

            segments.forEach(function (seg) {
                var el = document.getElementById(seg.id);
                if (el) {
                    var pct = seg.value / total;
                    var dash = pct * circumference;
                    el.style.strokeDasharray = dash + ' ' + circumference;
                    el.style.strokeDashoffset = -offset;
                    offset += dash;
                }
            });

            DOM.donutTotal.textContent = kpis.totalStops;
        }

        function renderBarChart(routes) {
            // Mostra top 6 rotas com maior quantidade de entregas
            var sorted = routes.slice().sort(function (a, b) { return b.total - a.total; }).slice(0, 6);
            var maxVal = Math.max.apply(null, sorted.map(function (r) { return r.total; }).concat([1]));

            var colors = {
                'finalizado': '#22c55e',
                'emrota': '#3b82f6',
                'nocliente': '#f59e0b',
                'critico': '#ef4444',
                'retorno': '#f97316',
                'reentrega': '#64748b'
            };

            DOM.barChart.innerHTML = sorted.map(function (route) {
                var height = (route.total / maxVal) * 140;
                var color = colors[route.status] || '#6366f1';
                var label = route.key.length > 10 ? route.key.substring(0, 10) + '...' : route.key;
                return '<div class="bar-item">' +
                    '<div class="bar" style="height:' + height + 'px;background:' + color + '" data-value="' + route.finalizadas + '/' + route.total + '"></div>' +
                    '<span class="bar-label">' + label + '</span>' +
                    '</div>';
            }).join('');
        }

        function getStatusLabel(status) {
            var labels = {
                'finalizado': '‚úì Finalizado',
                'emrota': 'üöö Em Rota',
                'nocliente': '‚è∞ No Cliente',
                'critico': 'üî¥ Cr√≠tico',
                'retorno': '‚Ü©Ô∏è Retorno',
                'reentrega': '‚ôªÔ∏è Reentrega'
            };
            return labels[status] || status;
        }

        function renderProgressRing(progress) {
            var circumference = 2 * Math.PI * 14;
            var offset = circumference - (progress / 100) * circumference;
            return '<svg class="progress-ring" viewBox="0 0 36 36">' +
                '<circle class="progress-ring-bg" cx="18" cy="18" r="14" fill="none" stroke-width="4"/>' +
                '<circle class="progress-ring-fill" cx="18" cy="18" r="14" fill="none" stroke-width="4" ' +
                'stroke-dasharray="' + circumference + '" stroke-dashoffset="' + offset + '" transform="rotate(-90 18 18)"/>' +
                '</svg>';
        }

        function renderTable(routes) {
            if (routes.length === 0) {
                DOM.routesTableBody.innerHTML = '';
                DOM.tableEmpty.classList.add('visible');
                return;
            }
            DOM.tableEmpty.classList.remove('visible');
            DOM.routesTableBody.innerHTML = routes.map(function (route) {
                var clickupLink = route.taskUrl || 'https://app.clickup.com';
                return '<tr>' +
                    '<td><div class="route-name"><span class="route-key">' + route.key + '</span><span class="route-id">' + route.total + ' entregas</span></div></td>' +
                    '<td><span class="status-badge ' + route.status + '">' + getStatusLabel(route.status) + '</span></td>' +
                    '<td><div class="cell-progress">' + renderProgressRing(route.progress) + '<span class="progress-text">' + route.finalizadas + '/' + route.total + ' (' + route.progress + '%)</span></div></td>' +
                    '<td>' + (route.currentClient ? '<div class="client-info"><span class="client-name">' + route.currentClient.name + '</span><span class="client-address">' + route.currentClient.address + '</span></div>' : '<span class="time-ago">-</span>') + '</td>' +
                    '<td><span class="time-ago">' + formatTimeAgo(route.lastUpdate) + '</span></td>' +
                    '<td><a href="' + clickupLink + '" target="_blank" class="action-btn" title="Abrir no ClickUp"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></a></td>' +
                    '</tr>';
            }).join('');
        }

        function updateLastUpdateTime() {
            DOM.lastUpdate.innerHTML = '<span class="pulse-dot"></span><span>Atualizado: ' + formatTime(new Date()) + '</span>';
        }

        // ===== Filtering =====
        function applyFilters() {
            var filtered = state.routes.slice();
            if (state.currentFilter !== 'all') {
                filtered = filtered.filter(function (r) { return r.status === state.currentFilter; });
            }
            if (state.searchQuery) {
                var query = state.searchQuery.toLowerCase();
                filtered = filtered.filter(function (r) {
                    return r.key.toLowerCase().indexOf(query) !== -1 ||
                        (r.currentClient && r.currentClient.name.toLowerCase().indexOf(query) !== -1);
                });
            }
            state.filteredRoutes = filtered;
            renderTable(filtered);
        }

        // ===== Polling State =====
        var pollingState = {
            inFlight: false,
            intervalId: null,
            baseInterval: 120000,    // 120s when idle
            activeInterval: 30000,   // 30s when user active
            idleTimeout: null,
            isUserActive: true
        };

        // ===== API (via google.script.run) =====
        function fetchData() {
            // In-flight guard: prevent overlapping requests
            if (pollingState.inFlight) {
                console.log('[Dashboard] Request already in flight, skipping...');
                return;
            }
            pollingState.inFlight = true;
            DOM.btnRefresh.classList.add('loading');

            google.script.run
                .withSuccessHandler(function (result) {
                    pollingState.inFlight = false;
                    DOM.btnRefresh.classList.remove('loading');
                    DOM.loadingOverlay.classList.add('hidden');
                    if (result && result.data) {
                        state.rawData = result.data;
                        state.routes = processRoutes(result.data);
                        var kpis = calculateKPIs(state.routes);
                        renderKPIs(kpis);
                        renderDonutChart(kpis);
                        renderBarChart(state.routes);
                        applyFilters();
                        updateLastUpdateTime();
                        showToast('Dados atualizados!', 'success');
                    } else {
                        showToast('Nenhum dado retornado', 'error');
                    }
                })
                .withFailureHandler(function (err) {
                    pollingState.inFlight = false;
                    DOM.btnRefresh.classList.remove('loading');
                    DOM.loadingOverlay.classList.add('hidden');
                    showToast('Erro: ' + err.message, 'error');
                })
                .getDashboardData();
        }

        function showToast(message, type) {
            var toast = document.createElement('div');
            toast.className = 'toast ' + (type || 'info');
            toast.textContent = message;
            DOM.toastContainer.appendChild(toast);
            setTimeout(function () { toast.remove(); }, 4000);
        }

        // ===== Polling Control =====
        function startPolling() {
            if (pollingState.intervalId) {
                clearInterval(pollingState.intervalId);
            }
            var interval = pollingState.isUserActive
                ? pollingState.activeInterval
                : pollingState.baseInterval;
            pollingState.intervalId = setInterval(fetchData, interval);
        }

        function handleVisibilityChange() {
            if (document.hidden) {
                // Tab hidden: stop polling
                if (pollingState.intervalId) {
                    clearInterval(pollingState.intervalId);
                    pollingState.intervalId = null;
                }
            } else {
                // Tab visible: fetch immediately and restart polling
                fetchData();
                startPolling();
            }
        }

        function resetIdleTimer() {
            pollingState.isUserActive = true;
            // Only restart polling if interval changed
            if (pollingState.idleTimeout) clearTimeout(pollingState.idleTimeout);
            pollingState.idleTimeout = setTimeout(function () {
                pollingState.isUserActive = false;
                startPolling(); // Restart with longer interval
            }, 120000); // 2 min inactivity -> idle
        }

        // ===== Event Listeners =====
        function setupEventListeners() {
            DOM.searchInput.addEventListener('input', function (e) {
                state.searchQuery = e.target.value;
                applyFilters();
            });

            DOM.filterChips.addEventListener('click', function (e) {
                if (e.target.classList.contains('chip')) {
                    document.querySelectorAll('.chip').forEach(function (c) { c.classList.remove('active'); });
                    e.target.classList.add('active');
                    state.currentFilter = e.target.dataset.filter;
                    applyFilters();
                }
            });

            DOM.btnRefresh.addEventListener('click', function () { fetchData(); });

            document.querySelectorAll('.kpi-card').forEach(function (card) {
                card.addEventListener('click', function () {
                    var status = card.dataset.status;
                    if (status && status !== 'total') {
                        document.querySelectorAll('.chip').forEach(function (c) { c.classList.remove('active'); });
                        var matchingChip = document.querySelector('.chip[data-filter="' + status + '"]');
                        if (matchingChip) {
                            matchingChip.classList.add('active');
                            state.currentFilter = status;
                        } else {
                            document.querySelector('.chip[data-filter="all"]').classList.add('active');
                            state.currentFilter = 'all';
                        }
                        applyFilters();
                    }
                });
            });

            // Visibility API: pause polling when tab hidden
            document.addEventListener('visibilitychange', handleVisibilityChange);

            // Idle detection: track user activity
            ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'].forEach(function (evt) {
                document.addEventListener(evt, resetIdleTimer, { passive: true });
            });
        }

        // ===== Init =====
        setupEventListeners();
        fetchData();
        startPolling();
        resetIdleTimer();
    </script>
</body>

</html>