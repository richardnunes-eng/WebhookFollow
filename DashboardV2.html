<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸš€ Dashboard V2.1 | Operacional</title>
    <base target="_top">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* Palette based on premium dark theme */
            --bg-body: #0f172a;
            /* Slate 900 */
            --bg-card: #1e293b;
            /* Slate 800 */
            --bg-panel: #1e293b;
            --bg-hover: #334155;
            /* Slate 700 */

            --text-primary: #f8fafc;
            /* Slate 50 */
            --text-secondary: #94a3b8;
            /* Slate 400 */
            --text-muted: #64748b;
            /* Slate 500 */

            --accent-primary: #3b82f6;
            /* Blue 500 */

            --status-success: #22c55e;
            --status-warning: #f59e0b;
            --status-error: #ef4444;
            --status-info: #3b82f6;

            --border-color: #334155;

            /* Spacing */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;

            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        * {
            box-sizing: border-box;
            outline: none;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-body);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-hover);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1920px;
            margin: 0 auto;
        }

        /* Header */
        header {
            padding: var(--space-md) var(--space-lg);
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .brand h1 {
            margin: 0;
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            font-size: 1.25rem;
            background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .badge-v2 {
            background: var(--accent-primary);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
            margin-left: 8px;
        }

        .meta-info {
            display: flex;
            gap: 24px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .meta-item {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .meta-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .meta-value {
            font-family: 'Outfit', monospace;
            font-weight: 500;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--status-success);
            display: inline-block;
            box-shadow: 0 0 8px var(--status-success);
        }

        /* Main */
        main {
            flex: 1;
            padding: var(--space-lg);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--space-lg);
        }

        /* Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
        }

        .kpi-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            display: flex;
            flex-direction: column;
            gap: 4px;
            transition: transform 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            border-color: var(--text-muted);
        }

        .kpi-title {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
        }

        .kpi-sub {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Charts */
        .charts-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-md);
            min-height: 280px;
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            display: flex;
            flex-direction: column;
            grid-column: span 1;
        }

        .chart-card.wide {
            grid-column: span 2;
        }

        @media (max-width: 1400px) {
            .charts-row {
                grid-template-columns: 1fr 1fr;
            }

            .chart-card {
                grid-column: auto;
            }
        }

        @media (max-width: 768px) {
            .charts-row {
                grid-template-columns: 1fr;
            }
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .chart-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-container {
            flex: 1;
            position: relative;
            min-height: 180px;
        }

        /* Operational Panel */
        .ops-panel {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        /* Alerts Bar */
        .alerts-bar {
            display: flex;
            gap: var(--space-md);
            flex-wrap: wrap;
        }

        .alert-chip {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .alert-chip:hover {
            background: var(--bg-hover);
            border-color: var(--text-muted);
        }

        .alert-chip.active {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--accent-primary);
        }

        .alert-count {
            background: var(--bg-hover);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .alert-label {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .chip-red .alert-count {
            background: rgba(239, 68, 68, 0.2);
            color: var(--status-error);
        }

        .chip-yellow .alert-count {
            background: rgba(245, 158, 11, 0.2);
            color: var(--status-warning);
        }

        /* Filters Toolbar */
        .filters-toolbar {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-md);
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 600;
        }

        .filter-select {
            background: var(--bg-body);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 10px;
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            min-width: 140px;
        }

        .search-input {
            background: var(--bg-body);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 10px;
            border-radius: var(--radius-sm);
            width: 200px;
            font-size: 0.85rem;
        }

        .btn-clear {
            margin-left: auto;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.8rem;
        }

        .btn-clear:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        /* Split View */
        .split-view {
            display: flex;
            gap: var(--space-md);
            flex: 1;
            min-height: 500px;
            position: relative;
            overflow: hidden;
        }

        .table-section {
            flex: 1;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .table-wrapper {
            flex: 1;
            overflow: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        th {
            background: var(--bg-hover);
            color: var(--text-secondary);
            font-weight: 600;
            text-align: left;
            padding: 10px 14px;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            color: var(--text-primary);
            background: #3e4c60;
        }

        td {
            padding: 10px 14px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-muted);
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-primary);
            cursor: pointer;
        }

        /* Drawer */
        .drawer {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 450px;
            background: var(--bg-panel);
            border-left: 1px solid var(--border-color);
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.4);
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .drawer.open {
            transform: translateX(0);
        }

        .drawer-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-hover);
        }

        .drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .meta-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .meta-box {
            background: var(--bg-body);
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .meta-box label {
            display: block;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .meta-box span {
            font-size: 0.9rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .client-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem;
        }

        .client-status {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--bg-hover);
            color: var(--text-muted);
        }

        /* Utility Classes */
        .text-sm {
            font-size: 0.75rem;
        }

        .badge-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-final {
            background: rgba(34, 197, 94, 0.1);
            color: var(--status-success);
        }

        .status-rota {
            background: rgba(245, 158, 11, 0.1);
            color: var(--status-warning);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--status-error);
        }

        #loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg-body);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s;
        }
    </style>
</head>

<body>

    <div id="loading-overlay">
        <div style="font-size: 2rem;">ðŸš€</div>
        <p style="margin-top: 16px; color: var(--text-muted);">Carregando Dashboard V2...</p>
    </div>

    <div class="app-container">
        <header>
            <div class="brand">
                <h1>Dashboard Operacional</h1>
                <span class="badge-v2">V2.1</span>
            </div>
            <div class="meta-info">
                <div class="meta-item">
                    <span class="meta-label">Status</span>
                    <div style="display:flex; align-items:center; gap:6px;">
                        <div id="conn-dot" class="status-indicator"></div>
                        <span class="meta-value" id="conn-text">Online</span>
                    </div>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Atualizado</span>
                    <span class="meta-value" id="last-update">--:--</span>
                </div>
            </div>
        </header>

        <main>
            <!-- KPIs -->
            <section class="kpi-grid">
                <div class="kpi-card">
                    <span class="kpi-title">Planos Ativos</span>
                    <span class="kpi-value" id="kpi-planos">0</span>
                </div>
                <div class="kpi-card">
                    <span class="kpi-title">Progresso</span>
                    <span class="kpi-value" style="color:var(--status-success)" id="kpi-progresso">0%</span>
                </div>
                <div class="kpi-card">
                    <span class="kpi-title">OcorrÃªncias</span>
                    <span class="kpi-value" style="color:var(--status-error)" id="kpi-ocorrencias">0</span>
                    <span class="kpi-sub">
                        <span class="text-sm" style="color:var(--status-error)">Sinistros: <b
                                id="kpi-sinistro">0</b></span>
                    </span>
                </div>
                <div class="kpi-card">
                    <span class="kpi-title">Tempo MÃ©dio (Finalizados)</span>
                    <span class="kpi-value" style="color:var(--status-info)" id="kpi-tempo">0m</span>
                    <span class="kpi-sub">P95: <b id="kpi-p95">0m</b></span>
                </div>
            </section>

            <!-- Charts -->
            <section class="charts-row">
                <div class="chart-card">
                    <div class="chart-header"><span class="chart-title">Status dos Planos</span></div>
                    <div class="chart-container"><canvas id="chartStatus"></canvas></div>
                </div>
                <div class="chart-card wide">
                    <div class="chart-header"><span class="chart-title">Planos por RegiÃ£o</span></div>
                    <div class="chart-container"><canvas id="chartRegiao"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><span class="chart-title">Atrasos Ativos (Faixa)</span></div>
                    <div class="chart-container"><canvas id="chartBuckets"></canvas></div>
                </div>
            </section>

            <!-- Ops Panel -->
            <div class="ops-panel">
                <!-- Alerts -->
                <div class="alerts-bar" id="alerts-container">
                    <!-- Injected via JS -->
                </div>

                <!-- Filters -->
                <div class="filters-toolbar">
                    <div class="filter-group">
                        <label class="filter-label">Buscar / Rota / Placa</label>
                        <input type="text" id="inp-search" class="search-input" placeholder="Digite para buscar...">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">RegiÃ£o</label>
                        <select id="sel-regiao" class="filter-select">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <select id="sel-status" class="filter-select">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Progresso</label>
                        <select id="sel-progresso" class="filter-select">
                            <option value="">Qualquer</option>
                            <option value="0">0% (InÃ­cio)</option>
                            <option value="1-99">1-99% (Andamento)</option>
                            <option value="100">100% (ConcluÃ­do)</option>
                        </select>
                    </div>
                    <button class="btn-clear" onclick="app.clearFilters()">Limpar Filtros</button>
                    <div style="flex:1; text-align:right; font-size:0.8rem; color:var(--text-muted);" id="rows-count">
                        0 registros
                    </div>
                </div>
            </div>

            <!-- Table Section -->
            <section class="split-view">
                <div class="table-section">
                    <div class="table-wrapper">
                        <table id="table-plans">
                            <thead>
                                <tr>
                                    <th onclick="app.sort('routeKey')">Plano/Rota</th>
                                    <th onclick="app.sort('motorista')">Motorista</th>
                                    <th onclick="app.sort('regiao')">RegiÃ£o</th>
                                    <th onclick="app.sort('entregas')">Entregas</th>
                                    <th onclick="app.sort('progresso')">Progresso</th>
                                    <th onclick="app.sort('status')">Status</th>
                                    <th onclick="app.sort('flags')">Flags</th>
                                    <th onclick="app.sort('tempo')">Atraso Atual</th>
                                </tr>
                            </thead>
                            <tbody id="table-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Drawer -->
                <div id="drawer" class="drawer">
                    <div class="drawer-header">
                        <span class="panel-title" id="drawer-title">Detalhes</span>
                        <button class="close-btn" onclick="app.closeDrawer()">âœ•</button>
                    </div>
                    <div class="drawer-content">
                        <div class="meta-grid" id="drawer-meta"></div>

                        <div style="margin-top:16px;">
                            <h4
                                style="font-size:0.8rem; text-transform:uppercase; color:var(--text-muted); margin-bottom:8px;">
                                Clientes / Subtasks</h4>
                            <div class="filter-group">
                                <input type="text" id="inp-drawer-search" class="search-input" style="width:100%"
                                    placeholder="Filtrar clientes...">
                            </div>
                        </div>

                        <div id="drawer-clients"></div>

                        <div style="margin-top:auto; padding-top:16px;">
                            <a href="#" target="_blank" id="btn-clickup"
                                style="display:block; text-align:center; padding:10px; background:var(--accent-primary); color:white; text-decoration:none; border-radius:6px; font-weight:600;">Abrir
                                no ClickUp</a>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const app = {
            data: null,
            filters: { search: '', regiao: '', status: '', progresso: '', activeAlert: null },
            sort: { col: 'routeKey', dir: 'asc' },
            charts: {},
            pollingTimer: null,

            init: function () {
                this.loadState();
                this.fetchData();
                this.startPolling();

                // Event Listeners
                document.addEventListener('visibilitychange', () => {
                    document.hidden ? this.stopPolling() : (this.fetchData(), this.startPolling());
                });

                ['inp-search', 'sel-regiao', 'sel-status', 'sel-progresso'].forEach(id => {
                    document.getElementById(id).addEventListener('input', (e) => {
                        const key = id.split('-')[1]; // search, regiao...
                        this.filters[key] = e.target.value;
                        this.saveState();
                        this.renderTable();
                    });
                });

                document.getElementById('inp-drawer-search').addEventListener('input', (e) => this.renderDrawerClients(e.target.value));
            },

            loadState: function () {
                try {
                    const s = JSON.parse(localStorage.getItem('dash_v2_state'));
                    if (s) {
                        this.filters = { ...this.filters, ...s.filters };
                        this.sort = s.sort || this.sort;
                        // Restore inputs
                        document.getElementById('inp-search').value = this.filters.search;
                        document.getElementById('sel-progresso').value = this.filters.progresso;
                        if (this.filters.periodo) document.getElementById('sel-periodo').value = this.filters.periodo;
                    }
                } catch (e) { }
            },

            saveState: function () {
                localStorage.setItem('dash_v2_state', JSON.stringify({ filters: this.filters, sort: this.sort }));
            },

            fetchData: function () {
                const ov = document.getElementById('loading-overlay');
                google.script.run.withSuccessHandler(res => {
                    if (res.status === 'success') {
                        this.data = res.data;
                        document.getElementById('conn-text').textContent = "Online";
                        document.getElementById('conn-dot').style.background = "var(--status-success)";
                        ov.style.opacity = '0';
                        setTimeout(() => ov.style.display = 'none', 300);
                        this.updateUI();
                    } else {
                        console.error(res);
                    }
                }).getDashboardV2();
            },

            updateUI: function () {
                if (!this.data) return;
                const m = this.data.metricas;

                // Header
                document.getElementById('last-update').textContent = new Date(this.data.generatedAt).toLocaleTimeString();

                // KPIs
                document.getElementById('kpi-planos').textContent = m.totalPlanosAtivos;
                document.getElementById('kpi-progresso').textContent = m.progressoMedioPercent + '%';
                document.getElementById('kpi-ocorrencias').textContent = m.ocorrenciasCount;
                document.getElementById('kpi-sinistro').textContent = m.sinistroCount; // fixed
                document.getElementById('kpi-tempo').textContent = (m.tempoMedioNoClienteMin || 0) + 'm';
                document.getElementById('kpi-p95').textContent = (m.p95NoClienteMin || 0) + 'm';

                // Filters Options
                this.populateSelect('sel-regiao', Object.keys(m.planosPorRegiao).sort());
                this.populateSelect('sel-status', Object.keys(m.statusPlanosDistribuicao).sort());

                // Alerts Bar
                this.renderAlerts();

                // Charts
                this.renderCharts();

                // Table
                this.renderTable();
            },

            populateSelect: function (id, options) {
                const sel = document.getElementById(id);
                const current = sel.value;
                sel.innerHTML = `<option value="">Todos</option>`;
                options.forEach(o => {
                    const opt = document.createElement('option');
                    opt.value = o; opt.textContent = o;
                    sel.appendChild(opt);
                });
                sel.value = current; // restore selected
            },

            renderAlerts: function () {
                const m = this.data.metricas;
                const buckets = m.bucketsAtraso || {};
                const container = document.getElementById('alerts-container');
                container.innerHTML = '';

                const createChip = (label, count, colorClass, filterFn) => {
                    if (count === 0) return;
                    const chip = document.createElement('div');
                    chip.className = `alert-chip ${colorClass}`;
                    if (this.filters.activeAlert === label) chip.classList.add('active');

                    chip.onclick = () => {
                        if (this.filters.activeAlert === label) {
                            this.filters.activeAlert = null; // toggle off
                        } else {
                            this.filters.activeAlert = label;
                        }
                        this.renderAlerts(); // re-render to update active class
                        this.renderTable();
                    };

                    chip.innerHTML = `<span class="alert-count">${count}</span> <span class="alert-label">${label}</span>`;
                    container.appendChild(chip);
                };

                createChip('> 30 Min', buckets['31-60'] || 0, 'chip-yellow');
                createChip('> 60 Min', (buckets['61-120'] || 0) + (buckets['121+'] || 0), 'chip-red');
                createChip('OcorrÃªncias', m.ocorrenciasCount, 'chip-red');
                createChip('Pernoites', m.pernoiteCount, 'chip-yellow');
            },

            renderCharts: function () {
                const m = this.data.metricas;

                // Status Donut
                this.drawChart('chartStatus', 'doughnut', {
                    labels: Object.keys(m.statusPlanosDistribuicao),
                    datasets: [{ data: Object.values(m.statusPlanosDistribuicao), backgroundColor: ['#3b82f6', '#22c55e', '#f59e0b', '#ef4444', '#64748b'], borderWidth: 0 }]
                }, { plugins: { legend: { position: 'right', labels: { color: '#94a3b8' } } } });

                // Region Bar
                const regEntries = Object.entries(m.planosPorRegiao).sort((a, b) => b[1] - a[1]).slice(0, 8);
                this.drawChart('chartRegiao', 'bar', {
                    labels: regEntries.map(e => e[0]),
                    datasets: [{ label: 'Planos', data: regEntries.map(e => e[1]), backgroundColor: '#3b82f6', borderRadius: 4 }]
                }, { plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { grid: { color: '#334155' } } } });

                // Buckets Bar (New)
                const b = m.bucketsAtraso || {};
                this.drawChart('chartBuckets', 'bar', {
                    labels: ['0-30m', '31-60m', '61-120m', '120m+'],
                    datasets: [{ label: 'Clientes', data: [b['0-30'] || 0, b['31-60'] || 0, b['61-120'] || 0, b['121+'] || 0], backgroundColor: ['#22c55e', '#f59e0b', '#ef4444', '#7f1d1d'], borderRadius: 4 }]
                }, { plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { grid: { color: '#334155' } } } });
            },

            drawChart: function (id, type, data, options) {
                if (this.charts[id]) this.charts[id].destroy();
                this.charts[id] = new Chart(document.getElementById(id), {
                    type, data, options: { responsive: true, maintainAspectRatio: false, ...options }
                });
            },

            renderTable: function () {
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = '';

                let rows = this.data.planos;


                // 1. Text Filter
                if (this.filters.search) {
                    const t = this.filters.search.toLowerCase();
                    rows = rows.filter(r =>
                        (r.routeKey && r.routeKey.toLowerCase().includes(t)) ||
                        (r.motorista && r.motorista.toLowerCase().includes(t)) ||
                        (r.placa && r.placa.toLowerCase().includes(t))
                    );
                }

                // 2. Exact Filters
                if (this.filters.regiao) rows = rows.filter(r => r.regiao === this.filters.regiao);
                if (this.filters.status) rows = rows.filter(r => r.statusTask === this.filters.status);

                // 3. Progresso
                if (this.filters.progresso) {
                    if (this.filters.progresso === '0') rows = rows.filter(r => r.progressoPercent === 0);
                    if (this.filters.progresso === '100') rows = rows.filter(r => r.progressoPercent === 100);
                    if (this.filters.progresso === '1-99') rows = rows.filter(r => r.progressoPercent > 0 && r.progressoPercent < 100);
                }

                // 4. Alerts Filter
                if (this.filters.activeAlert) {
                    const label = this.filters.activeAlert;
                    if (label === 'OcorrÃªncias') rows = rows.filter(r => r.flags.includes('O'));
                    if (label === 'Pernoites') rows = rows.filter(r => r.flags.includes('P'));
                    if (label.includes('> 30')) {
                        // Need to check specific client times, tricky. 
                        // We'll filter plans that *have* a client in delay. 
                        // Since we don't have client details in 'planos', we look at metrics or approximate.
                        // Actually 'rankingTopAtrasosAtivos' helps but only top 10.
                        // Best effort: filter if we had a flag, but we don't have a specific delay flag on plan.
                        // We can use 'planos' if we add maxDelay to it in backend (todo for future). 
                        // For now, let's filter purely by Flags which is accurate for O/P.
                        // For delays, we can only filter if we fetch clients.
                        // Wait! In V2.1 plan we didn't add maxDelay to plan object. I will skip delay filtering on table for now OR implementing look up in clientsSummary
                        const clientsMap = this.data.clientes;
                        rows = rows.filter(r => {
                            const clients = clientsMap[r.taskId] || [];
                            return clients.some(c => {
                                if (c.f) return false; // completed
                                if (!c.c) return false; // not arrived
                                const mins = (Date.now() - c.c) / 60000;
                                return mins > 30 && mins <= 60;
                            });
                        });
                    }
                    if (label.includes('> 60')) {
                        const clientsMap = this.data.clientes;
                        rows = rows.filter(r => {
                            const clients = clientsMap[r.taskId] || [];
                            return clients.some(c => {
                                if (c.f) return false;
                                if (!c.c) return false;
                                const mins = (Date.now() - c.c) / 60000;
                                return mins > 60;
                            });
                        });
                    }
                }

                document.getElementById('rows-count').textContent = `${rows.length} registros`;

                // 5. Sort
                const col = this.sort.col;
                const mul = this.sort.dir === 'asc' ? 1 : -1;

                rows.sort((a, b) => {
                    let va = a[col], vb = b[col];
                    // Special getters
                    if (col === 'entregas') { va = a.entregasFeitas; vb = b.entregasFeitas; }
                    if (col === 'progresso') { va = a.progressoPercent; vb = b.progressoPercent; }
                    if (col === 'tempo') {
                        // Calc max active delay for this plan
                        const getMax = (taskId) => {
                            const cs = this.data.clientes[taskId] || [];
                            let max = 0;
                            cs.forEach(c => {
                                if (!c.f && c.c) max = Math.max(max, Date.now() - c.c);
                            });
                            return max;
                        };
                        va = getMax(a.taskId); vb = getMax(b.taskId);
                    }

                    if (va < vb) return -1 * mul;
                    if (va > vb) return 1 * mul;
                    return 0;
                });

                // Render
                const frag = document.createDocumentFragment();
                const limit = rows.length > 200 ? 50 : rows.length; // Simple limits for performance (lazy load later if needed)

                rows.slice(0, 100).forEach(r => { // Render top 100 for perf first
                    const tr = document.createElement('tr');
                    tr.onclick = () => this.openDrawer(r);

                    // Status Color
                    let stClass = 'status-rota';
                    const s = (r.statusTask || '').toLowerCase();
                    if (s.includes('final') || s.includes('entregue')) stClass = 'status-final';
                    else if (s.includes('problema') || s.includes('cancel')) stClass = 'status-error';

                    // Delay
                    const clients = this.data.clientes[r.taskId] || [];
                    let maxDelay = 0;
                    clients.forEach(c => { if (!c.f && c.c) maxDelay = Math.max(maxDelay, (Date.now() - c.c) / 60000); });
                    let delayHtml = '-';
                    if (maxDelay > 0) {
                        const style = maxDelay > 60 ? 'color:var(--status-error);font-weight:700' : (maxDelay > 30 ? 'color:var(--status-warning)' : '');
                        delayHtml = `<span style="${style}">${Math.round(maxDelay)}m</span>`;
                    }

                    tr.innerHTML = `
             <td>
               <div style="font-weight:500; color:var(--text-primary)">${r.routeKey}</div>
               <div class="text-sm" style="color:var(--text-muted)">${r.taskUrl ? 'ðŸ”—' : ''}</div>
             </td>
             <td>
               <div style="color:var(--text-primary)">${r.motorista || '-'}</div>
               <div class="text-sm">${r.placa || ''}</div>
             </td>
             <td>${r.regiao || 'MB'}</td>
             <td>${r.entregasFeitas}/${r.entregasPlanejadas}</td>
             <td>
               <div style="display:flex;align-items:center;gap:6px;">
                 <div class="progress-bar"><div class="progress-fill" style="width:${r.progressoPercent}%"></div></div>
                 <span class="text-sm">${r.progressoPercent}%</span>
               </div>
             </td>
             <td><span class="badge-status ${stClass}">${r.statusTask}</span></td>
             <td>
               ${r.flags?.includes('O') ? 'ðŸ”´' : ''}
               ${r.flags?.includes('P') ? 'ðŸŒ™' : ''}
               ${r.flags?.includes('S') ? 'ðŸ’¥' : ''}
             </td>
             <td>${delayHtml}</td>
           `;
                    frag.appendChild(tr);
                });
                tbody.appendChild(frag);
            },

            sortCallback: function (column) {
                if (this.sort.col === column) {
                    this.sort.dir = this.sort.dir === 'asc' ? 'desc' : 'asc';
                } else {
                    this.sort.col = column;
                    this.sort.dir = 'asc';
                }
                this.saveState();
                this.renderTable();
            },

            clearFilters: function () {
                this.filters = { search: '', regiao: '', status: '', progresso: '', activeAlert: null };
                document.getElementById('inp-search').value = '';
                document.getElementById('sel-regiao').value = '';
                document.getElementById('sel-status').value = '';
                document.getElementById('sel-progresso').value = '';
                this.saveState();
                this.renderTable();
                this.renderAlerts();
            },

            openDrawer: function (plan) {
                const d = document.getElementById('drawer');
                d.classList.add('open');
                document.getElementById('drawer-title').textContent = plan.routeKey;
                document.getElementById('btn-clickup').href = plan.taskUrl;

                const meta = document.getElementById('drawer-meta');
                meta.innerHTML = `
           <div class="meta-box"><label>Motorista</label><span>${plan.motorista || '-'}</span></div>
           <div class="meta-box"><label>VeÃ­culo</label><span>${plan.veiculo || '-'} (${plan.placa})</span></div>
           <div class="meta-box"><label>Modalidade</label><span>${plan.modalidade || '-'}</span></div>
           <div class="meta-box"><label>RegiÃ£o</label><span>${plan.regiao || '-'}</span></div>
           <div class="meta-box" style="grid-column:span 2"><label>Ãšltima Loc.</label><span>${plan.ultimaLocalizacao || '-'}</span></div>
         `;

                this.currentDrawerPlan = plan; // store for filtering
                this.renderDrawerClients();
            },

            closeDrawer: function () {
                document.getElementById('drawer').classList.remove('open');
                this.currentDrawerPlan = null;
            },

            renderDrawerClients: function (filterText = '') {
                if (!this.currentDrawerPlan) return;
                const container = document.getElementById('drawer-clients');
                const clients = this.data.clientes[this.currentDrawerPlan.taskId] || [];

                container.innerHTML = '';

                let list = clients;
                if (filterText) {
                    const f = filterText.toLowerCase();
                    list = list.filter(c => c.n.toLowerCase().includes(f));
                }

                if (list.length === 0) {
                    container.innerHTML = `<div style="color:var(--text-muted); text-align:center; padding:20px;">Nenhum cliente.</div>`;
                    return;
                }

                list.forEach(c => {
                    const el = document.createElement('div');
                    el.className = 'client-list-item';

                    let timeInfo = '';
                    if (c.f && c.c) {
                        // Finished
                        const min = Math.round((c.f - c.c) / 60000);
                        timeInfo = `<span style="color:var(--status-success); font-weight:600;">${min}m</span> (ok)`;
                    } else if (c.c && !c.f) {
                        // Active
                        const min = Math.round((Date.now() - c.c) / 60000);
                        const color = min > 60 ? 'var(--status-error)' : (min > 30 ? 'var(--status-warning)' : 'var(--status-info)');
                        timeInfo = `<span style="color:${color}; font-weight:700;">${min}m</span> no local`;
                    } else {
                        timeInfo = '<span style="color:var(--text-muted)">Pendente</span>';
                    }

                    el.innerHTML = `
              <div>
                <div style="font-weight:500; color:var(--text-primary)">${c.n}</div>
                <div class="text-sm" style="color:var(--text-muted)">${c.k || ''}</div>
              </div>
              <div style="text-align:right">
                <div class="client-status">${c.s}</div>
                <div class="text-sm">${timeInfo}</div>
              </div>
            `;
                    container.appendChild(el);
                });
            },

            startPolling: function () {
                if (this.pollingTimer) clearInterval(this.pollingTimer);
                this.pollingTimer = setInterval(() => this.fetchData(), 120000);
            },
            stopPolling: function () {
                if (this.pollingTimer) clearInterval(this.pollingTimer);
            },
            sort: function (col) { // Hook for HTML onclick
                this.sortCallback(col);
            }
        };

        // Global Access
        window.app = app;
        window.onload = () => app.init();
    </script>
</body>

</html>